<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mon Espace Audit Interne</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- FontAwesome et Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@600;800&display=swap" rel="stylesheet">
    <style>
      :root {
  --primary: #1a2540;
  --secondary: #007bff;
  --bg-light: #f5f7fb;
  --white: #fff;
  --green: #28a745;
  --red: #e74c3c;
  --shadow: 0 4px 20px rgba(30,40,80,0.08);
  --radius: 16px;
}

/* RESET & BASE */
html, body {
  margin: 0;
  padding: 0;
  min-height: 100vh;
  font-family: 'Roboto', 'Montserrat', Arial, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: #1a2540;
  background: var(--bg-light);
}
.hidden { display: none !important; }

/* PAGE DE CONNEXION CENTRÉE */
.login-background,
.login-centered-bg {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  background: url('https://kincy.fr/wp-content/uploads/2023/05/audit-kincy.jpg') center center/cover no-repeat;
  z-index: 0;
}
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(33, 49, 89, 0.60);
  z-index: 1;
}
.login-layout,
.login-centered-layout {
  position: relative;
  z-index: 2;
  min-height: 100vh;
  width: 100vw;
  display: flex;
  align-items: center;
  justify-content: center;
}
.login-block,
.login-centered-block {
  background: rgba(255,255,255,0.92);
  box-shadow: 0 8px 24px rgba(30,40,80,0.13);
  border-radius: 38px;
  padding: 48px 42px 40px 42px;
  display: flex;
  flex-direction: column;
  align-items: center;
  max-width: 550px;
  width: 100%;
  animation: fadeIn 1.2s;
}
.login-logo,
.login-centered-logo {
  display: block;
  margin: 0 auto 22px auto;
  width: 140px !important;
  height: auto !important;
}
.login-block h1,
.login-centered-title {
  font-family: 'Montserrat', sans-serif;
  font-size: 2.8rem;
  color: #2341a7;
  font-weight: 800;
  margin-bottom: 13px;
  letter-spacing: 0.04em;
  text-align: center;
}
.login-block h2,
.login-centered-subtitle {
  font-size: 1.3rem;
  color: #516083;
  margin-bottom: 34px;
  font-weight: 600;
  text-align: center;
}
.login-form,
.login-centered-form {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 28px;
}
.login-form input,
.login-centered-form input {
  width: 100%;
  max-width: 370px;
  padding: 16px 18px;
  margin-bottom: 20px;
  border: 1px solid #dbe1ec;
  border-radius: 10px;
  font-size: 1.15em;
  background: #f7fafc;
  box-sizing: border-box;
  transition: border-color 0.15s;
  text-align:left;
}
.login-form input:focus,
.login-centered-form input:focus {
  border-color: #2341a7;
}
.login-form button,
.login-centered-form button {
  width: 100%;
  max-width: 370px;
  background: #2341a7;
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 16px;
  font-size: 1.21em;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 2px 8px #2341a74d;
  transition: background 0.18s;
  margin-top: 7px;
}
.login-form button:hover,
.login-centered-form button:hover { background: #1a2540; }
.login-error {
  color: #e74c3c;
  margin-top: 10px;
  font-size: 1.09em;
  text-align: center;
}
.login-centered-welcome {
  width: 100%;
  text-align: center;
  margin-top: 26px;
}
.login-centered-welcome h3 {
  color: #2341a7;
  font-family: 'Montserrat', sans-serif;
  font-size: 1.55rem;
  margin-bottom: 16px;
  font-weight: 800;
  letter-spacing: 0.03em;
}
.login-centered-welcome p {
  color: #1a2540;
  font-size: 1.15rem;
  font-weight: 500;
  max-width: 440px;
  margin: 0 auto 20px auto;
  line-height: 1.6;
}
.audit-quote {
  font-size: 1.09rem;
  color: #516083;
  font-style: italic;
  margin-top: 20px;
  max-width: 420px;
  margin-left: auto;
  margin-right: auto;
}
.audit-quote i {
    margin-right: 8px;
    color: #2341a7;
}
@media (max-width: 700px) {
  .login-centered-block {
    border-radius: 0;
    padding: 18px 8px 20px 8px;
    max-width: 100vw;
  }
  .login-centered-logo {
    width: 90px !important;
    margin-bottom: 15px;
  }
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(15px);}
  to { opacity: 1; transform: translateY(0);}
    </style>
</head>
<body>
    <!-- LOGIN PAGE -->
    <div class="login-background"></div>
    <div class="overlay"></div>
    <div class="login-layout" id="loginPage">
        <!-- Bloc login à gauche -->
        <div class="login-block">
            <img src="LOGO_DMS-removebg-preview.png" alt="Logo" class="login-logo">
            <h1>Connexion</h1>
            <h2>Espace Audit Interne<br>Veuillez entrer vos identifiants</h2>
            <form id="loginForm" class="login-form">
                <input type="text" id="username" placeholder="Nom d'utilisateur" required>
                <input type="password" id="password" placeholder="Mot de passe" required>
                <button type="submit">Se connecter</button>
                <div id="loginError" class="login-error"></div>
            </form>
        </div>
        <!-- Bloc texte d'accueil à droite -->
        <div class="login-centered-welcome">
  <h3 style="
  color: #fff;
  font-family: 'Montserrat',sans-serif;
  font-size: 2.1rem;
  margin-bottom: 22px;
  font-weight: 900;
  letter-spacing: 0.03em;
">
  Bienvenue dans l'Espace Audit Interne
</h3>
  <p style="
  color: #fff;
  font-size: 1.25rem;
  font-style: italic;
  font-family: 'Montserrat', 'Roboto', Arial, sans-serif;
  margin-bottom: 28px;
  line-height: 1.8;
  text-align: left;
">
  -Visualisez et suivez vos missions d’audit en toute simplicité.<br>
  -Accédez à vos statistiques, rapportez vos progrès et exportez vos résultats en PDF.<br>
  -Un outil pensé pour la performance et la transparence.
</p>
  <div class="audit-quote" style="
  font-size: 1.25rem;
  color: #fff;
  font-style: italic;
  margin-top: 38px;
  margin-bottom: 0;
  text-align: left;
  font-family: 'Montserrat', 'Roboto', Arial, sans-serif;
  background: none;
  text-shadow: none;
  display: block;
">
  <i class="fas fa-quote-left" style="center:10px;color:#28a745;font-size:1.4em;"></i>
  <span style="color: #fff;">“L’audit interne, c’est l’assurance et l’amélioration continue pour l’organisation.”</span>
</div>
</div>
    </div>
    <!-- DASHBOARD PAGE -->
    <div id="dashboardPage" class="hidden">
        <header class="audit-header">
            <div style="display: flex; align-items: center;">
                <img src="LOGO_DMS-removebg-preview.png" alt="Logo" class="logo">
                <span class="audit-title">Espace Audit Interne</span>
            </div>
            <div class="user-profile">
                <img src="LOGO_DMS-removebg-preview.png" alt="Avatar" class="user-avatar">
                <span class="user-info" id="displayUserName">Nom Utilisateur</span>
                <button class="logout-btn" id="logout-button"><i class="fas fa-sign-out-alt"></i> Déconnexion</button>
            </div>
        </header>
        <div class="container">
            <div class="welcome-card">
                <i class="fas fa-user-tie"></i>
                <div>
                    <div class="welcome-text">Bienvenue sur votre tableau de bord personnel</div>
                    <div class="welcome-name" id="welcomeUser">[Nom Auditeur]</div>
                </div>
            </div>
            <div class="stats-row">
                <div class="stat-card">
                    <span class="stat-label">Missions Réalisées</span>
                    <span class="stat-value stat-green" id="realized-missions">0</span>
                    <span class="stat-icon"><i class="fas fa-check-circle"></i></span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Missions Non Réalisées</span>
                    <span class="stat-value stat-red" id="unrealized-missions">0</span>
                    <span class="stat-icon"><i class="fas fa-times-circle"></i></span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Rapports Diffusés</span>
                    <span class="stat-value stat-green" id="diffuse-reports">0</span>
                    <span class="stat-icon"><i class="fas fa-paper-plane"></i></span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Rapports Non diffusés</span>
                    <span class="stat-value stat-red" id="non-diffuse-reports">0</span>
                    <span class="stat-icon"><i class="fas fa-envelope-open-text"></i></span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Total Missions</span>
                    <span class="stat-value stat-blue" id="total-missions">0</span>
                    <span class="stat-icon"><i class="fas fa-list"></i></span>
                </div>
            </div>
            <div class="filters-bar">
                <div class="filter-box">
                    <i class="fas fa-building filter-icon"></i>
                    <input type="text" id="searchSociety" placeholder="Filtrer par société">
                </div>
                <div class="filter-box">
                    <i class="fas fa-sitemap filter-icon"></i>
                    <input type="text" id="searchPole" placeholder="Filtrer par pôle">
                </div>
                <div class="filter-actions">
                    <button type="button" class="action-btn export" id="exportPdfButton"><i class="fas fa-file-pdf"></i> Exporter PDF</button>
                    <button type="button" class="action-btn" id="showAllButton"><i class="fas fa-list"></i> Tout afficher</button>
                </div>
            </div>
            <div class="table-card">
                <div class="table-title">Vos missions</div>
                <div id="dataDisplay"></div>
                <div class="no-data" id="noDataMsg" style="display:none;">Aucune mission à afficher.</div>
            </div>
        </div>
    </div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<script>
// --- Identifiants privés ---
const SPREADSHEET_ID = '1JsbNg0BbuNP94tXtS09X6qbGv8Cf2hKUWUzZJbzeOVI';
const API_KEY = 'AIzaSyAfJDEkFh0J9K0ngYPgtYhOs5P_Q8WEyTc';
const SHEET_NAME = 'PROGRAMME';
const RANGE_DATA = 'A6:K';
const TABLE_HEADERS = ["SOCIETE", "POLE", "ENTITE", "DEBUT", "FIN", "DUREE", "RESPONSABLE", "AUDITEUR 1", "AUDITEUR 2", "STATUT", "RAPPORT"];
const USERS_SHEET = 'USERS';
const USERS_RANGE = 'B3:D';

let allData = [];
let currentFilteredData = [];
let filterTimeout;
let loggedResponsible = '';

async function fetchUsers() {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${USERS_SHEET}!${USERS_RANGE}?key=${API_KEY}`;
    const resp = await fetch(url);
    const data = await resp.json();
    return (data.values || []).map(row => ({
        username: row[0],
        password: row[1],
        responsible: row[2]
    }));
}

document.addEventListener('DOMContentLoaded', () => {
    const loginForm = document.getElementById('loginForm');
    const loginPage = document.getElementById('loginPage');
    const dashboardPage = document.getElementById('dashboardPage');
    const loginError = document.getElementById('loginError');
    const logoutButton = document.getElementById('logout-button');
    const passwordInput = document.getElementById('password');
    const searchSociety = document.getElementById('searchSociety');
    const searchPole = document.getElementById('searchPole');
    const exportPdfButton = document.getElementById('exportPdfButton');
    const showAllButton = document.getElementById('showAllButton');
    const displayUserName = document.getElementById('displayUserName');
    const welcomeUser = document.getElementById('welcomeUser');

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const usernameInput = document.getElementById('username').value;
        const passwordInputVal = passwordInput.value;
        const users = await fetchUsers();
        const found = users.find(u => u.username === usernameInput && u.password === passwordInputVal);
        if (found) {
            loggedResponsible = found.responsible;
            displayUserName.textContent = found.responsible;
            welcomeUser.textContent = found.responsible;
            loginPage.classList.add('hidden');
            dashboardPage.classList.remove('hidden');
            // Masque le fond et overlay de la connexion
            document.querySelector('.login-background').style.display = 'none';
            document.querySelector('.overlay').style.display = 'none';
            await fetchGoogleSheetData();
        } else {
            loginError.textContent = 'Nom d\'utilisateur ou mot de passe incorrect.';
            loginError.style.display = 'block';
        }
    });

    logoutButton.addEventListener('click', () => {
        dashboardPage.classList.add('hidden');
        loginPage.classList.remove('hidden');
        document.getElementById('username').value = '';
        passwordInput.value = '';
        loginError.style.display = 'none';
        searchSociety.value = '';
        searchPole.value = '';
        displayMessage("Veuillez commencer à taper pour voir les résultats.");
        updateStats(allData);
        // Réaffiche le fond et overlay de la connexion
        document.querySelector('.login-background').style.display = '';
        document.querySelector('.overlay').style.display = '';
    });
    searchSociety.addEventListener('input', triggerFilter);
    searchPole.addEventListener('input', triggerFilter);
    exportPdfButton.addEventListener('click', () => exportToPdf(currentFilteredData));
    showAllButton.addEventListener('click', showAllData);
});

function triggerFilter() {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(filterData, 200);
}

async function fetchGoogleSheetData() {
    try {
        const dataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}!${RANGE_DATA}?key=${API_KEY}`;
        const dataResponse = await fetch(dataUrl);
        if (!dataResponse.ok) throw new Error(`Erreur HTTP: ${dataResponse.status}`);
        const data = await dataResponse.json();
        allData = data.values || [];
        sortDataByDate(allData);
        updateStats(allData);
        showAllData();
    } catch (error) {
        displayMessage("Erreur lors du chargement des données. Veuillez vérifier la connexion.");
    }
}
function sortDataByDate(data) {
    const dateIndex = 3;
    data.sort((a, b) => parseDate(a[dateIndex]) - parseDate(b[dateIndex]));
}
function parseDate(dateString) {
    if (!dateString) return new Date(0);
    const parts = dateString.split('/');
    if (parts.length !== 3) return new Date(0);
    return new Date(parts[2], parts[1] - 1, parts[0]);
}
function displayData(dataToDisplay) {
    // Filtre missions pour l'utilisateur connecté (dans RESPONSABLE, AUDITEUR 1, AUDITEUR 2)
    const name = loggedResponsible.trim().toLowerCase();
    const responsibleFiltered = dataToDisplay.filter(row => (
        (row[6] || '').trim().toLowerCase() === name ||
        (row[7] || '').trim().toLowerCase() === name ||
        (row[8] || '').trim().toLowerCase() === name
    ));
    let filtered = responsibleFiltered;
    const societyFilterValue = document.getElementById('searchSociety').value.trim().toLowerCase();
    const poleFilterValue = document.getElementById('searchPole').value.trim().toLowerCase();
    if (societyFilterValue !== '' || poleFilterValue !== '') {
        filtered = responsibleFiltered.filter(row => {
            const societyCell = String(row[0] || '').toLowerCase();
            const poleCell = String(row[1] || '').toLowerCase();
            const societyMatch = societyFilterValue === '' || societyCell.includes(societyFilterValue);
            const poleMatch = poleFilterValue === '' || poleCell.includes(poleFilterValue);
            return societyMatch && poleMatch;
        });
    }
    currentFilteredData = filtered;
    if (!filtered || filtered.length === 0) {
        displayMessage("Aucun résultat ne correspond à votre recherche.");
        return;
    }
    const tableDiv = createTable(filtered);
    const dataDisplayElement = document.getElementById('dataDisplay');
    dataDisplayElement.innerHTML = '';
    dataDisplayElement.appendChild(tableDiv);
    updateStats(filtered);
}
function filterData() {
    if (allData.length === 0) return;
    displayData(allData);
}
function displayMessage(message) {
    const dataDisplayElement = document.getElementById('dataDisplay');
    dataDisplayElement.innerHTML = `<div class="no-data-message">${message}</div>`;
}
function exportToPdf(dataToExport) {
    if (!dataToExport || dataToExport.length === 0) {
        alert("Aucune donnée à exporter.");
        return;
    }
    const tempContainer = document.createElement('div');
    tempContainer.style.padding = '15px';
    tempContainer.style.width = '2200px';
    tempContainer.style.maxWidth = 'none';
    tempContainer.style.overflowX = 'auto';
    const logo = document.createElement('img');
    logo.src = "LOGO_DMS-removebg-preview.png";
    logo.style.display = "block";
    logo.style.margin = "0 auto 10px auto";
    logo.style.width = "120px";
    tempContainer.appendChild(logo);
    const now = new Date();
    const dateTime = now.toLocaleDateString('fr-FR') + " " + now.toLocaleTimeString('fr-FR');
    const datePara = document.createElement('div');
    datePara.style.textAlign = "center";
    datePara.style.marginBottom = "10px";
    datePara.style.fontSize = "1.1em";
    datePara.innerHTML = `<strong>Téléchargé le :</strong> ${dateTime}`;
    tempContainer.appendChild(datePara);
    const title = document.createElement('h2');
    title.textContent = "Programme d'audit interne 2025";
    title.style.textAlign = 'center';
    title.style.marginBottom = '18px';
    tempContainer.appendChild(title);
    const table = document.createElement('table');
    table.style.borderCollapse = 'collapse';
    table.style.width = '2200px';
    table.style.maxWidth = 'none';
    table.style.tableLayout = 'auto';
    table.style.fontSize = "0.95em";
    table.style.marginTop = "10px";
    table.style.overflowX = "auto";
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    TABLE_HEADERS.forEach(headerText => {
        const th = document.createElement('th');
        th.textContent = headerText;
        th.style.border = '1px solid #999';
        th.style.background = '#e9ecef';
        th.style.padding = '4px';
        th.style.textAlign = 'center';
        th.style.fontWeight = 'bold';
        th.style.width = "200px";
        th.style.wordBreak = "break-word";
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    dataToExport.forEach(rowData => {
        const tr = document.createElement('tr');
        rowData.forEach((cellData, index) => {
            const td = document.createElement('td');
            td.textContent = cellData;
            td.style.border = '1px solid #999';
            td.style.padding = '3px 2px';
            td.style.wordBreak = "break-word";
            td.style.textAlign = "center";
            td.style.width = "200px";
            if(index===9) {
                td.style.background = "#28a745";
                td.style.color = "#fff";
                td.style.fontWeight = "bold";
            } else if(index===10) {
                const rapportStatus = String(cellData || '').toLowerCase().trim();
                td.style.fontWeight = "bold";
                if (rapportStatus === 'diffusé') {
                    td.style.background = "#28a745";
                    td.style.color = "#fff";
                } else if (rapportStatus === 'non diffusé') {
                    td.style.background = "#dc3545";
                    td.style.color = "#fff";
                }
            }
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    tempContainer.appendChild(table);
    const options = {
        margin: [10, 10, 10, 10],
        filename: 'programme_audit_interne.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 3 },
        jsPDF: { unit: 'mm', format: 'a2', orientation: 'landscape' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };
    html2pdf().set(options).from(tempContainer).save();
}
function showAllData() {
    document.getElementById('searchSociety').value = '';
    document.getElementById('searchPole').value = '';
    displayData(allData);
    updateStats(currentFilteredData);
}
function createTable(dataToDisplay) {
    const table = document.createElement('table');
    table.className = "table-auto";
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');
    const headerRow = document.createElement('tr');
    TABLE_HEADERS.forEach(headerText => {
        const th = document.createElement('th');
        th.textContent = headerText;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    dataToDisplay.forEach(rowData => {
        const tr = document.createElement('tr');
        rowData.forEach((cellData, index) => {
            const td = document.createElement('td');
            td.textContent = cellData;
            const statutIndex = 9;
            const rapportIndex = 10;
            if (index === statutIndex) {
                const status = String(cellData || '').toLowerCase().trim();
                td.classList.add('status-cell');
                if (status === 'r') {
                    td.classList.add('status-green');
                } else if (status === 'nr') {
                    td.classList.add('status-red');
                }
            } else if (index === rapportIndex) {
                const rapportStatus = String(cellData || '').toLowerCase().trim();
                td.classList.add('status-cell');
                if (rapportStatus === 'diffusé') {
                    td.classList.add('status-green');
                } else if (rapportStatus === 'non diffusé') {
                    td.classList.add('status-red');
                }
            }
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    return table;
}
function updateStats(data) {
    if (!data) return;
    let totalMissions = 0, realizedMissions = 0, unrealizedMissions = 0, diffusedReports = 0, nonDiffusedReports = 0;
    const statutIndex = 9, rapportIndex = 10;
    const name = loggedResponsible.trim().toLowerCase();
    data.forEach(row => {
        if (
            (row[6] || '').trim().toLowerCase() !== name &&
            (row[7] || '').trim().toLowerCase() !== name &&
            (row[8] || '').trim().toLowerCase() !== name
        ) return;
        totalMissions++;
        const missionStatus = String(row[statutIndex] || '').toLowerCase().trim();
        const rapportStatus = String(row[rapportIndex] || '').toLowerCase().trim();
        if (["r", "réalisé", "réalisée"].includes(missionStatus)) realizedMissions++;
        else if (["nr", "non réalisé", "non réalisée"].includes(missionStatus)) unrealizedMissions++;
        if (rapportStatus === 'diffusé') diffusedReports++;
        if ((["r", "réalisé", "réalisée"].includes(missionStatus)) && rapportStatus === 'non diffusé') nonDiffusedReports++;
    });
    document.getElementById('total-missions').textContent = totalMissions;
    document.getElementById('realized-missions').textContent = realizedMissions;
    document.getElementById('unrealized-missions').textContent = unrealizedMissions;
    document.getElementById('diffuse-reports').textContent = diffusedReports;
    document.getElementById('non-diffuse-reports').textContent = nonDiffusedReports;
}
</script>
</body>
</html>
